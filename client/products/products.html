<html ng-app="products_app">
<head>
  <title>Products</title>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.26/angular.min.js"></script>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <script type="text/javascript" src="./products_factory.js"></script>
  <link rel="stylesheet" href="./products_style.css">

</head>

<body ng-controller="productsController">

  <div><span id="navBar"></span><a href="" ng-click="logout()">logout {{myName}}</a></div>


  <h1>ITEMS</h1>
  <input class = "feedback-input" type="text" ng-model="filter_name" placeholder="search items">

  <h3 style = "margin-top: 0px;">Include Tags</h3>
  <select  style = "margin-bottom: 0px;" id="search-tag" class = "feedback-input" id = "tagList" name="tagOptions" ng-change="searchTag()" ng-model="searchTagSelected"> <!-- ng-model="new_product.tags[new_product.tags.length]">-->
    <option value="">Search Tags</option>
    <option ng-repeat="tag in tags" ng-bind="tag.name" value="{{tag.name}}"></option>
  </select>

  <br>
  <span>
    &nbsp;
    <span class="tag-class" ng-repeat="sTag in searchTags">
      <span ng-bind="sTag"></span>
      <button ng-click="removeSearchTag(sTag)"><span aria-hidden="true">&times;</span></button>
    </span>
    &nbsp;
  </span>
  <br>

  <h3 style = "margin-top: 0px;">Exclude Tags</h3>
  <select id="exclude-tag" class = "feedback-input" id = "tagList" name="tagOptions" ng-change="excludeTag()" ng-model="excludeTagSelected">
    <option value="" disabled selected>Exclude Tags</option>
    <option ng-repeat="tag in tags" ng-bind="tag.name" value="{{tag.name}}"></option>
  </select>

  <br>
  <span>
    &nbsp;
    <span class="tag-class" ng-repeat="eTag in excludeTags">
      <span ng-bind="eTag"></span>
      <button ng-click="removeExcludeTag(eTag)"><span aria-hidden="true">&times;</span></button>
    </span>
    &nbsp;
  </span>
  <br>


  <div class="customerTable" id = "cTable" style="height:30em; margin: 0px 5%; width: 90%;">
    <table id = "myItemTable">
      <tr>
        <td> Name </td>
        <td> Model </td>
        <td> Total </td>
        <td> Available </td>
        <td ng-show="authorized"> Total On Loan </td>
        <td ng-show="!authorized"> On Loan to Me </td>
        <td> Tags </td>
        <td> Action </td>
      </tr>

      <tr ng-repeat="product in products | filter: filter_name | orderBy:'-date' | limitTo: paginationLimit()">
        <td ng-bind="product.name"></td>
        <td ng-bind="product.model"></td>
        <td ng-bind="product.quantity"></td>
        <td ng-bind="product.quantity_available"></td>
        <td ng-show="authorized" ng-bind="product.quantity - product.quantity_available"></td>
        <td ng-show="!authorized" ng-bind="calculateMyLoans(product)"></td>
        <td ng-bind="product.tags"></td>
        <!--<td><button class="remove" ng-click="viewProduct(product)" data-toogle="modal" data-target"#productModal">View</button></td>-->
        <td><button class = "remove" ng-click='viewProduct(product)' data-toggle="modal" data-target="#productModal">View</button></td>
      </tr>
    </table>
  </div>

    <button class = "remove" style="margin-top:1em; width: 20%; color: black;" ng-show="hasMoreItemsToShow()" ng-click="showMoreItems()">
      Show more
 </button>


<span ng-show="authorized">
<!--<span ng-controller="productsController">-->
  <h1>Add an Item</h1>

  <form id="createItemForm">
    <input class = "feedback-input" type="text" ng-model="new_product.name" placeholder="name" required>
    <!--<input class = "feedback-input" type="url" ng-model="new_product.image_url" placeholder="image url">-->
    <textarea class = "feedback-input" ng-model="new_product.description" placeholder="description"></textarea>
    <input class = "feedback-input" type="text" ng-model="new_product.model" placeholder="model">

<!--
    <br>
    <span>
      &nbsp;
      <span class="tag-class" ng-repeat="cTag in currentTags">
        <span ng-bind="cTag"></span>
        <button ng-click="removeTag(cTag)"><span aria-hidden="true">&times;</span></button>
      </span>
      &nbsp;
    </span>
    <br>

    <select id="tag_select_modal" class = "feedback-input" ng-controller="productsController" id = "tagList" name="tagOptions">
      <option value="" disabled selected>Add a Tag</option>
      <option value="1" ng-click="createNewTag()">Create New Tag</option>
      <option ng-repeat="tag in tags" ng-bind="tag.name" ng-click="tagClicked(tag)"></option>
    </select>
  -->

    <!--<textarea class = "feedback-input" ng-model="new_product.tags" placeholder="tags (comma separated)"></textarea>-->


    <input class = "feedback-input" type="number" min="1" ng-model="new_product.quantity" placeholder="quantity" required>

    <!-- REQUIREMENT: assets -->
     <!-- <input class = "feedback-input" type="number" min="1" ng-model="new_product.assetTag" placeholder="Add an asset tag if you wish to configure this item as assets."> -->
     <select id="asset_select" class="feedback-input" name="assetOptions" ng-change="assetClicked()" ng-model="assetOption">
      <option value="" selected>This item is not an asset.</option>
      <option value="isAsset">This item is an asset.</option>
    </select>


     <h3>Custom Fields</h3>
    <div ng-repeat="field in fields">
      <input ng-show="field.type=='short-form'"class="feedback-input" type="text" ng-model="new_product.fields[field.name]" placeholder="{{field.name}}">

      <textarea ng-show="field.type=='long-form'"class="feedback-input" type="text" ng-model="new_product.fields[field.name]" placeholder="{{field.name}}"></textarea>
      <input ng-show="field.type=='integer'"class="feedback-input" type="number" ng-model="new_product.fields[field.name]" placeholder="{{field.name}}">
      <input ng-show="field.type=='floating-point'"class="feedback-input" type="number" step="0.01" ng-model="new_product.fields[field.name]" placeholder="{{field.name}}">

    </div>

    <br>

    <span>
      &nbsp;
      <span class="tag-class" ng-repeat="cTag in currentTags">
        <span ng-bind="cTag"></span>
        <button ng-click="removeTag(cTag)"><span aria-hidden="true">&times;</span></button>
      </span>
      &nbsp;
    </span>
    <br>

    <select id="tag_select_modal" class="feedback-input" id="tagList" name="tagOptions" ng-change="tagClicked()" ng-model="tagSelected">
      <option value="">Add a Tag</option>
      <option value="createNewTag">Create New Tag</option>
      <option ng-repeat="tag in tags" ng-bind="tag.name" value="{{tag.name}}"></option>
    </select>

    <div class="error" ng-if="errorMessage">{{ errorMessage }}</div>

    <input type="submit" ng-disabled="createItemForm.$invalid" ng-click="addProduct()">
    <br>
  </form>
</span>
<!--</span>-->
<!--TODO: Formatting-->

<!-- PRODUCT MODAL -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" ng-click="closeItemModal()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="exampleModalLabel">View Item</h1>
      </div>
      <div class="modal-body" align="left">
        <div class="form-group" >
          <label><b>Name: </b></label>
          <input id=productName type="text" ng-readonly="!editing" ng-model="currentProduct.name" required/>
          <p>
            <label><b>Model:  </b></label>
            <input type="text" ng-readonly="!editing" ng-model="currentProduct.model"/>
          </p>
          <p>
            <label><b>Quantity:  </b></label>
            <input ng-show="adminOnly" type="number" min="0" ng-readonly="currentProduct.isAsset || (!currentProduct.isAsset && !editing)" ng-model="currentProduct.quantity"required/>
            <span ng-show="!adminOnly" ng-bind="currentProduct.quantity" />
          </p>
          <p>
            <label><b>Quantity Available:  </b></label>
            <input ng-show="adminOnly" type="number" min="0" ng-readonly="currentProduct.isAsset || (!currentProduct.isAsset && !editing)" ng-model="currentProduct.quantity_available"required/>
            <span ng-show="!adminOnly" ng-bind="currentProduct.quantity_available" />
          </p>
          <p>
            <label><b>Description:  </b></label>
            <textarea ng-readonly="!editing" ng-model="currentProduct.description"></textarea>
          </p>


          <p>
            <label><b>Item:  </b></label>
            <!-- <input type="checkbox" ng-disabled="!editing" ng-model="currentProduct.isAsset"> -->
            <div class="slideThree">  
            <input type="checkbox" ng-disabled="!editing" ng-model="currentProduct.isAsset" ng-bind="currentProduct.isAsset" value="assetSelected" id="slideThree" name="check" />
            <label for="slideThree"></label>
          </div>

          </p>


          <p ng-repeat="field in fields">
            <span ng-show="authorized || field.access=='public'">
              <label><b>{{ field.name }}: </b></label>
              <input ng-show="field.type=='short-form'" type="text" ng-readonly="!editing" ng-model="currentProduct.fields[field.name]">
              <textarea ng-show="field.type=='long-form'"type="text" ng-readonly="!editing" ng-model="currentProduct.fields[field.name]"></textarea>
              <input ng-show="field.type=='integer'" type="number" ng-readonly="!editing" ng-model="currentProduct.fields[field.name]">
              <input ng-show="field.type=='floating-point'" type="number" step="0.01" ng-readonly="!editing" ng-model="currentProduct.fields[field.name]">
            </span>
          </p>
          <p>
            <label><b>Tags:  </b><label>
            <span>
              &nbsp;
              <div class="tag-class hack-inline" ng-repeat="cTag in currentTags">
                <span ng-bind="cTag"></span>
                <button ng-show="editing" ng-click="currentTags.splice($index, 1)"><span aria-hidden="true">&times;</span></button>
              </div>
              &nbsp;
            </span>
            <br>
          </p>
          <p>
            <select id="tag_select_main" class="feedback-input" id="tagList" name="tagOptions" ng-change="tagClicked()" ng-model="tagSelected">
              <option value="">Add a Tag</option>
              <option value="createNewTag">Create New Tag</option>
              <option ng-repeat="tag in tags" ng-bind="tag.name" value="{{tag.name}}"></option>
            </select>
          </p>
        </div>
        <br>
        <div class="modal-footer">
          <span ng-show="adminOnly">
            <button class="btn btn-danger" data-toggle="modal" data-target="#deleteConfirmModal">Delete Product</button>
          </span>
          <button type="button" class="btn btn-secondary" ng-click="closeItemModal()" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" ng-click="requestProduct(thisProduct)" data-toggle="modal" data-target="#requestModal">Add to Cart</button>
          <span ng-show="authorized">
            <button type="button" class="btn btn-primary" ng-click="editProduct(currentProduct)">{{editing == true ? 'Save Edits' : 'Edit' }}</button>
            <button type="button" class="btn btn-primary" ng-click="deltaQuantity(currentProduct)" ng-show="!currentProduct.isAsset">Log Loss/Aquires</button>
          </span>
        </div>
        <br>
        <h2>Requests made on this item</h2>
        <div class="customerTable" id = "cTable">
          <table>
            <tr>
              <td> User Name </td>
              <td> # of Items </td>
              <td> Date Issued </td>
              <td> Status </td>
              <td> Type </td>
              <td> View Request </td>
            </tr>
            <tr ng-repeat="order in orders | filter: filter_name | orderBy:'-date'">
              <td style="display:none;" ng-bind="order._id"></td>
              <td ng-bind="order.customer_name || order.user.username"></td>
              <td ng-bind="order.items.length"></td>
              <td ng-bind="order.date | date:'short'"></td>
              <td ng-bind="order.status"></td>
              <td ng-bind="order.type"></td>
              <td><button class = "remove" ng-click='viewOrder(order)' data-toggle="modal" data-target="#orderModal">View</button></td>
            </tr>
            <!--
            <tr ng-repeat="order in orders | filter: filter_name | orderBy:'-status'">
              <td ng-bind="order.customer_name || order.user.username"></td>
              <td ng-bind="order.item_name"></td>
              <td ng-bind="order.quantity"></td>
              <td ng-bind="order.date | date:'short'"></td>
              <td ng-bind="order.dateDone | date:'short'"></td>
              <td ng-bind="order.status"></td>
            </tr>
          -->
          </table>
        </div>


        <!-- todo: make assets -->
        <!-- <p style="display:none;">{{sampleAssets = [{"assetTag": 1, "fieldVal": 11}, {"assetTag": 2, "fieldVal": 22}] }}</p> -->
        <!-- ASSETS -->
        <div ng-show="currentProduct.isAsset">
            <h2>Assets</h2>
            <div class="customerTable" id = "cTable2">
              <table>
                <tr>
                    <!-- <td ng-repeat="aField in assetFields" > {{aField.name}}</td> -->
                    <td>Asset Tag</td>
                    <td>View Asset</td>
                </tr>
                <tr ng-repeat="asset in currentProduct.assets">
                    <td>{{asset.assetTag}}</td>
                    <!-- <td ng-repeat="aField in assetFields" > {{asset.fieldVal}}</td> -->
                    <td> <button class = "remove" ng-click='viewAsset(asset)' data-toggle="modal" data-target="#assetModal">View</button> </td>
                </tr>
              </table>
            </div>
        </div>  


      </div>
    </div>
  </div>
</div>



<!-- ASSET MODAL -->

<div class="modal fade" id="assetModal" tabindex="-2" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" ng-click="closeItemModal()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="exampleModalLabel">View Asset</h1>
      </div>
      <!-- <p>{{currentAsset}}</p> -->
      <!-- <p>{{thisAsset}}</p> -->
      <div class="modal-body" align="left">
        <div class="form-group" >
          <label><b>Asset Tag: </b></label>
          <input type="text" ng-readonly="!editing" ng-model="currentAsset.assetTag" required/>
          <p>
            <h3>Fields:</h3>
            <div style="margin-left:1em;" ng-repeat="field in currentAsset.fields">
              <label><b>{{field.name}}:  </b></label>
              <input type="text" ng-readonly="!editing" ng-model="field.value"/>
            </div>
          </p>
          
        </div>
        <br>
        <div class="modal-footer">
          <span ng-show="adminOnly">
            <button class="btn btn-danger" data-toggle="modal" data-target="#deleteConfirmAssetModal">Delete Asset</button>
          </span>
          <button type="button" class="btn btn-secondary" ng-click="closeItemModal()" data-dismiss="modal">Close</button>
          <!-- <button type="button" class="btn btn-primary" ng-click="requestProduct(thisProduct)" data-toggle="modal" data-target="#requestModal">Add to Cart</button> -->
          <span ng-show="authorized">
            <button type="button" class="btn btn-primary" ng-click="editAsset(currentProduct)">{{editing == true ? 'Save Edits' : 'Edit' }}</button>
                    <!-- TODO CHANGE TO EDIT THIS ASSET -->

          </span>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- DELETE CONFIRM ASSET MODAL -->
<div class="modal fade" id="deleteConfirmAssetModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="exampleModalLabel">Confirm Deletion</h1>
      </div>
      <div class="modal-body" align="left">
        <div class="form-group" >
          Confirm Deletion
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=confirmDeleteModal(thisProduct)>Confirm</button>
          <!-- TODO CHANGE TO DELETE THIS ASSET -->
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=cancelDeleteModal()>Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!--REQUEST MODAL -->

<div class="modal fade" id="requestModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>

      </button>
        <h1 class="modal-title" id="exampleModalLabel">Add Item to Cart</h1>

    </div>
    <div class="modal-body" align="center">
      <h2>Add to Cart</h2>

      <!--
      <span ng-show="authorized">
      <select class = "feedback-input" ng-controller="customersController" id = "customerList" name="customerOptions" ng-model="new_order.userId">
        <option value="" selected disabled>User Name</option>
        <option ng-repeat="customer in customers" value="{{customer._id}}" ng-bind="customer.name"></option>
      </select>
    -->
      </span>

<!--
      <select class = "feedback-input" ng-controller="productsController" id = "productList" name="productsOptions" ng-model="new_order.product">
          <option value="" selected disabled>Products</option>
           <option ng-repeat="product in products" value="{{product.name}}">{{product.name}} || {{product.description}}</option>
       </select>
     -->
     <form id="addOrderForm">
       <input class = "feedback-input" type="text" value="{{currentProduct.name}}" ng-readonly="true" />


        <input class = "feedback-input" type="number" min="1" ng-model="new_order.quantity" placeholder="quantity">
        <!--
        <textarea class = "feedback-input" ng-model="new_order.reason" placeholder="Reason"></textarea>
      -->
        <input type="submit" ng-click="addOrder()">
      </form>


    <div class="modal-footer">
      <!--
      <button class="btn btn-danger" ng-click='deleteProduct($event, thisProduct)' >Delete Product</button>
    -->


      <button type="button" class="btn btn-secondary close" aria-hidden="true" data-dismiss="modal" aria-label="Close">Close</button>

      <!--
      <button class = "remove" ng-click='viewProduct(product)' data-toggle="modal" data-target="#productModal">View</button>

      <button type="button" class="btn btn-primary" ng-click="requestProduct(thisProduct)" data-toggle="modal" data-target="#requestModal">Request</button>
      <button type="button" class="btn btn-primary" ng-click="editProduct(thisProduct)">Edit</button>
    -->

    </div>
  </div>
</div>
</div>
</div>

<!-- DELETE CONFIRM MODAL -->
<div class="modal fade" id="deleteConfirmModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="exampleModalLabel">Confirm Deletion</h1>
      </div>
      <div class="modal-body" align="left">
        <div class="form-group" >
          Confirm Deletion
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=confirmDeleteModal(thisProduct)>Confirm</button>
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=cancelDeleteModal()>Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT CONFIRM MODAL -->
<div class="modal fade" id="editConfirmModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="exampleModalLabel">Confirm Edits</h1>
      </div>
      <div class="modal-body" align="left">
        <div class="form-group" >
          Confirm Edits
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=confirmEditModal(currentProduct)>Confirm</button>
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=cancelEditModal(currentProduct)>Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!--DELTA QUANTITY MODAL -->
<div class="modal fade" id="deltaQuantityModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h1 class="modal-title" id="exampleModalLabel">Log Losses and Aquisitions of Product</h1>
      </div>
      <div class="modal-body" align="left">
        <div class="form-group" >
          <label><b>Change in item quantity:  </b></label>
          <input class = "feedback-input" type="number" ng-model="deltaQuantity" required>
        </div>
        <div class="error" ng-show="errorMessage">{{ errorMessage }}</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=confirmDeltaQuantity(currentProduct)>Confirm</button>
          <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=cancelDeltaQuantity(currentProduct)>Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- NEW TAG MODAL -->
<div class="modal fade" id="newTagModal" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>

      </button>
        <h1 class="modal-title" id="exampleModalLabel">Add a Tag</h1>

    </div>
    <div class="modal-body" align="left">
      <div class="form-group" >
        <label><b>New Tag:  </b></label>
        <input class="feedback-input" type="text" ng-model="newTag.name">
      </div>
    </div>


    <div class="modal-footer">

      <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=confirmNewTag(thisProduct)>Confirm</button>

      <button type="button" class="btn btn-secondary" aria-hidden="true" ng-click=cancelNewTag(thisProduct)>Cancel</button>

    </div>
  </div>
</div>
</div>



  <script type="text/javascript">
    $('#productModal').on('show.bs.modal', function (event) {
      console.log("product modal called");
      var button = $(event.relatedTarget);
      var modal = $(this);
    })
  </script>

  <script type="text/javascript">
    $('#requestModal').on('show.bs.modal', function (event) {
      console.log("request modal called");
      var button = $(event.relatedTarget);
      var modal = $(this);
    })
  </script>

</body>
</html>
